---
tags:
- Technology/BA
- Difficulty/Intermediate
---
----
## Какой shard key вы выберете для пользовательского сервиса с 10+ млн записей, и как это отразится на запросах и транзакциях
----
> [!FAQ]- Ответ
> - Для сервиса управления данными пользователей, содержащего более 10 миллионов записей, я бы выбрал User_ID (в частности, UUID) в качестве ключа шардирования, поскольку он обеспечивает высокую кардинальность и равномерное распределение данных по кластеру. С точки зрения системного анализа, основная цель — избежать «горячих точек», которые часто возникают при использовании ключей с низкой кардинальностью, таких как Geographic_Region или Account_Type. Использование уникального User_ID гарантирует равномерное распределение требований к хранению данных и пропускной способности операций чтения/записи по всем физическим разделам. Это критически важно для выполнения нефункциональных требований, связанных с масштабируемостью, и предотвращения превращения какого-либо отдельного узла в узкое место производительности в периоды пиковой нагрузки.
> - Выбор User_ID существенно влияет на производительность запросов, оптимизируя наиболее распространенный шаблон доступа: получение или обновление данных конкретного пользователя. Запросы, включающие User_ID, могут быть направлены непосредственно на единственный соответствующий шард, что приводит к высокоэффективным ответам с низкой задержкой. Однако это создает компромисс для запросов, основанных на атрибутах, не являющихся ключами, например, поиск пользователя по адресу электронной почты или номеру телефона. Эти запросы потребуют операции «рассылки-сбора», когда ядро ​​базы данных должно будет транслировать запрос на все шарды и агрегировать результаты, увеличивая задержку и накладные расходы на обработку. Чтобы снизить этот риск, я бы рекомендовал реализовать глобальный вторичный индекс или выделенный сервис сопоставления для обработки поиска по электронной почте, гарантируя, что система поддерживает стандарты производительности для различных типов запросов.
> - Что касается транзакций, шардирование по User_ID гарантирует, что операции, ограниченные одним пользователем, — такие как обновление профиля или изменение настроек, — остаются локальными для одного шарда. Это позволяет системе поддерживать строгие свойства ACID с минимальными накладными расходами, обеспечивая целостность данных и быстрое подтверждение транзакций. Однако транзакции между пользователями, такие как перевод средств или связывание учетных записей, расположенных на разных шардах, становятся значительно сложнее. Эти сценарии потребуют протоколов распределенных транзакций, таких как двухфазная фиксация (2PC), которые могут снизить производительность, или перехода к моделям с конечной согласованностью. Таким образом, выбор User_ID является оптимальным стратегическим решением, поскольку он приоритезирует производительность наиболее частых, изолированных пользовательских операций, одновременно ограничивая сложность менее частыми взаимодействиями между несколькими пользователями.